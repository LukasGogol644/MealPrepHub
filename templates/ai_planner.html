<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI-Wochenplan Generator - MealPrep Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .goal-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid var(--border-color);
            padding: 1.5rem;
            text-align: center;
        }
        .goal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px var(--shadow);
        }
        .goal-card.selected {
            border-color: var(--accent-1);
            background-color: var(--accent-1);
        }
        .goal-card.selected h4 {
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">MealPrep Hub</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Rezepte</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/ai-planner">KI-Planer</a></li>
                    <li class="nav-item"><a class="nav-link" href="/week-plan">Wochenplan</a></li>
                    <li class="nav-item"><a class="nav-link" href="/shopping-list">Einkaufsliste</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <!-- Hero -->
        <div class="hero-section text-center mb-5">
            <h1 class="display-4 fw-bold mb-3">KI-Wochenplan Generator</h1>
            <p class="lead">Wähle dein Ernährungsziel und lass die KI einen personalisierten Plan erstellen</p>
        </div>

        <!-- Step 1: Goal Selection -->
        <div id="step1" class="mb-5">
            <h2 class="text-center mb-4">Schritt 1: Wähle dein Ziel</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="goal-card card" onclick="selectGoal('Muskelaufbau', 2500, 150, this)">
                        <h4>Muskelaufbau</h4>
                        <p class="text-muted">Protein-reich</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="goal-card card" onclick="selectGoal('Abnehmen', 1800, 120, this)">
                        <h4>Abnehmen</h4>
                        <p class="text-muted">Kaloriendefizit</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="goal-card card" onclick="selectGoal('Vegan', 2000, 80, this)">
                        <h4>Vegan</h4>
                        <p class="text-muted">Pflanzlich</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="goal-card card" onclick="selectGoal('Vegetarisch', 2000, 90, this)">
                        <h4>Vegetarisch</h4>
                        <p class="text-muted">Fleischfrei</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="goal-card card" onclick="selectGoal('High Protein', 2300, 180, this)">
                        <h4>High Protein</h4>
                        <p class="text-muted">Maximales Protein</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="goal-card card" onclick="selectGoal('Ausgewogen', 2200, 100, this)">
                        <h4>Ausgewogen</h4>
                        <p class="text-muted">Gesund & vielseitig</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Fine-tuning -->
        <div id="step2" class="mb-5 d-none">
            <h2 class="text-center mb-4">Schritt 2: Feinabstimmung</h2>
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Kalorien pro Tag:</label>
                            <input type="range" class="form-range" id="caloriesSlider"
                                   min="1200" max="4000" step="100" value="2000"
                                   oninput="updateCaloriesValue(this.value)">
                            <div class="text-center">
                                <span id="caloriesValue" class="badge bg-primary fs-5">2000 kcal</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Protein pro Tag:</label>
                            <input type="range" class="form-range" id="proteinSlider"
                                   min="50" max="250" step="10" value="100"
                                   oninput="updateProteinValue(this.value)">
                            <div class="text-center">
                                <span id="proteinValue" class="badge bg-success fs-5">100g Protein</span>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg px-5" onclick="generatePlan()">
                            <span id="generateBtnText">Wochenplan jetzt generieren</span>
                            <span id="generateSpinner" class="d-none">
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Generiere...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingSection" class="text-center my-5 d-none">
            <div class="spinner-border" style="width: 4rem; height: 4rem; color: var(--text-primary);"></div>
            <h3 class="mt-4">KI erstellt deinen optimalen Wochenplan...</h3>
            <p class="text-muted">Das kann 10-20 Sekunden dauern</p>
        </div>

        <!-- Results -->
        <section id="resultsSection" class="d-none">
            <h2 class="text-center mb-4">Dein KI-generierter Wochenplan</h2>

            <div class="card shadow-lg mb-4">
                <div class="card-header">
                    <h4 class="mb-0">KI-Empfehlung</h4>
                </div>
                <div class="card-body">
                    <div id="aiReasoning"></div>
                </div>
            </div>

            <div id="weekPlanDisplay" class="row g-4"></div>

            <div class="text-center mt-5">
                <button class="btn btn-success btn-lg px-5" onclick="saveToWeekPlan()">
                    Zum Wochenplan hinzufügen
                </button>
                <button class="btn btn-outline-light btn-lg px-5 ms-3" onclick="location.reload()">
                    Neuen Plan erstellen
                </button>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="mt-5">
        <div class="container text-center">
            <p class="mb-0 fs-5">MealPrep Hub © 2026</p>
            <small class="text-muted d-block mb-3">KI-gestützter Wochenplaner</small>
            <div class="footer-buttons">
                <a href="/" class="footer-btn">Rezepte</a>
                <a href="/ai-planner" class="footer-btn">KI-Planer</a>
                <a href="/week-plan" class="footer-btn">Wochenplan</a>
                <a href="/shopping-list" class="footer-btn">Einkaufsliste</a>
                <a href="/impressum" class="footer-btn">Impressum</a>
            </div>
            <div class="mt-3">
                <small class="text-muted">Powered by OpenAI GPT-4o & TheMealDB API</small>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedGoal = null;
        let currentPlan = null;

        function selectGoal(goal, calories, protein, element) {
            selectedGoal = goal;

            document.querySelectorAll('.goal-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');

            document.getElementById('caloriesSlider').value = calories;
            document.getElementById('proteinSlider').value = protein;
            updateCaloriesValue(calories);
            updateProteinValue(protein);

            document.getElementById('step2').classList.remove('d-none');
            document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
        }

        function updateCaloriesValue(value) {
            document.getElementById('caloriesValue').textContent = value + ' kcal';
        }

        function updateProteinValue(value) {
            document.getElementById('proteinValue').textContent = value + 'g Protein';
        }

        async function generatePlan() {
            if (!selectedGoal) {
                alert('Bitte wähle erst ein Ziel!');
                return;
            }

            const calories = parseInt(document.getElementById('caloriesSlider').value);
            const protein = parseInt(document.getElementById('proteinSlider').value);

            document.getElementById('generateBtnText').classList.add('d-none');
            document.getElementById('generateSpinner').classList.remove('d-none');
            document.getElementById('loadingSection').classList.remove('d-none');

            try {
                const response = await fetch('/api/generate-ai-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal: selectedGoal, calories: calories, protein: protein })
                });

                const data = await response.json();

                if (data.success) {
                    currentPlan = data.plan;
                    displayPlan(data);
                } else {
                    alert('Fehler: ' + data.error);
                }
            } catch (error) {
                alert('Fehler: ' + error);
            } finally {
                document.getElementById('generateBtnText').classList.remove('d-none');
                document.getElementById('generateSpinner').classList.add('d-none');
                document.getElementById('loadingSection').classList.add('d-none');
            }
        }

        function displayPlan(data) {
            document.getElementById('aiReasoning').innerHTML = `
                <h5><strong>Dein Ziel:</strong> ${data.goal}</h5>
                <p><strong>Tagesziele:</strong> ${data.daily_targets.calories} kcal • ${data.daily_targets.protein}g Protein</p>
                <hr>
                <p><strong>KI-Empfehlung:</strong> ${data.plan.reasoning || 'Optimaler Plan!'}</p>
            `;

            const days = {
                'monday': 'Montag', 'tuesday': 'Dienstag', 'wednesday': 'Mittwoch',
                'thursday': 'Donnerstag', 'friday': 'Freitag', 'saturday': 'Samstag', 'sunday': 'Sonntag'
            };

            let html = '';
            for (const [dayKey, dayName] of Object.entries(days)) {
                if (data.plan[dayKey]) {
                    const dayData = data.plan[dayKey];
                    html += `
                        <div class="col-lg-4 col-md-6">
                            <div class="card h-100 shadow">
                                <div class="card-header"><h5 class="mb-0">${dayName}</h5></div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="text-muted">Frühstück</h6>
                                        ${dayData.breakfast_thumb ? `<img src="${dayData.breakfast_thumb}" class="img-fluid rounded mb-2" style="height:100px; width:100%; object-fit:cover;">` : ''}
                                        <p class="fw-bold">${dayData.breakfast || '-'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-muted">Mittagessen</h6>
                                        ${dayData.lunch_thumb ? `<img src="${dayData.lunch_thumb}" class="img-fluid rounded mb-2" style="height:100px; width:100%; object-fit:cover;">` : ''}
                                        <p class="fw-bold">${dayData.lunch || '-'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-muted">Abendessen</h6>
                                        ${dayData.dinner_thumb ? `<img src="${dayData.dinner_thumb}" class="img-fluid rounded mb-2" style="height:100px; width:100%; object-fit:cover;">` : ''}
                                        <p class="fw-bold">${dayData.dinner || '-'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            document.getElementById('weekPlanDisplay').innerHTML = html;
            document.getElementById('resultsSection').classList.remove('d-none');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function saveToWeekPlan() {
            if (!currentPlan) { alert('Kein Plan!'); return; }

            const weekPlan = {};
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            for (const day of days) {
                if (currentPlan[day]) {
                    weekPlan[day] = [];
                    ['breakfast', 'lunch', 'dinner'].forEach(meal => {
                        if (currentPlan[day][meal]) {
                            weekPlan[day].push({
                                id: currentPlan[day][`${meal}_id`] || 'unknown',
                                name: currentPlan[day][meal],
                                thumb: currentPlan[day][`${meal}_thumb`] || '',
                                category: 'KI-generiert'
                            });
                        }
                    });
                }
            }

            localStorage.setItem('weekPlan', JSON.stringify(weekPlan));
            alert('Wochenplan gespeichert!');
            window.location.href = '/week-plan';
        }
    </script>
</body>
</html>